
    








<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>文章后台管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }
    .btn { padding: 8px 16px; background: #333; color: #fff; border: none; cursor: pointer; margin-right: 5px; }
    .btn:hover { background: #555; }
    .hidden { display: none; }
    textarea, input[type="text"], input[type="file"] { width: 100%; margin: 5px 0; }
    table { width: 100%; max-width: 960px; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    th { background: #f0f0f0; }
    .admin-bar { display: flex; justify-content: space-between; align-items: center; max-width: 960px; width: 100%; margin-bottom: 20px; flex-wrap: wrap; }
    .admin-bar > input { flex: 1; min-width: 200px; margin: 5px; }
    .admin-bar > div { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; min-width: 200px; margin: 5px; }
    #previewModal { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: white; padding: 20px; border: 1px solid #ccc; max-width: 700px; width: 90%; z-index: 999; overflow-y: auto; max-height: 80vh; }
    #previewModal h3 { margin-top: 0; }
    #previewModal img { max-width: 100%; }
    #markdownContent { white-space: pre-wrap; }
    @media (max-width: 768px) {
      .admin-bar { flex-direction: column; align-items: stretch; }
      .btn, textarea { width: 100%; margin: 5px 0; }
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tbody tr { border: 1px solid #ddd; margin-bottom: 15px; background: #fff; padding: 10px; }
      tbody td { display: flex; justify-content: space-between; padding: 8px 5px; border: none; border-bottom: 1px solid #eee; }
      tbody td::before { content: attr(data-label); font-weight: bold; color: #555; flex: 1; margin-right: 10px; }
      #submitBtn, #cancelEditBtn { width: 100%; }
    }
  </style>
</head>
<body>

<h1>📰 文章后台管理</h1>
<div id="authArea"><button id="loginBtn" class="btn">使用 GitHub 登录</button></div>

<div id="adminArea" class="hidden">
  <!-- 管理界面省略保持原样 -->
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const API_BASE = 'https://api.oliverfr.com/api';
const ADMIN_EMAIL = 'oliveroogle@gmail.com';

// 去除 URL 中的 access_token hash（如 #access_token=...）
if (location.hash.includes('access_token=')) {
  history.replaceState(null, '', location.pathname);
}

async function getCurrentUser() {
  try {
    const res = await fetch(`${API_BASE}/auth-github/session`, { credentials: 'include' });
    if (!res.ok) return null;
    const json = await res.json();
    return json.user || json.data?.user || null;
  } catch (e) {
    console.error('getCurrentUser error', e);
    return null;
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  const authArea      = document.getElementById('authArea');
  const adminArea     = document.getElementById('adminArea');
  const loginBtn      = document.getElementById('loginBtn');
  const logoutBtn     = document.getElementById('logoutBtn');

  const user = await getCurrentUser();
  if (user?.email === ADMIN_EMAIL) {
    authArea.classList.add('hidden');
    adminArea.classList.remove('hidden');
    loadArticles();
  }

  loginBtn.onclick = () => {
    const redirectUrl = encodeURIComponent('https://oliverfr.com/admin-mefan-articles.html');
    window.location.href = `${API_BASE}/auth-github?redirect=${redirectUrl}`;
  };

  logoutBtn.onclick = async () => {
    await fetch(`${API_BASE}/auth-github/logout`, {
      method: 'POST',
      credentials: 'include'
    });
    location.reload();
  };
submitBtn.onclick = async () => {
      const title = document.getElementById('newTitle').value.trim();
      const content = document.getElementById('newContent').value.trim();
      if (!title || !content) return alert('标题或内容不能为空');

      const me = await getCurrentUser();
      if (!me) return alert('请先登录');

      let coverUrl = '';
      const file = document.getElementById('coverInput').files[0];
      if (file) {
        const fd = new FormData();
        fd.append('file', file);
        const upRes = await fetch(`${API_BASE}/upload-cover`, {
          method: 'POST',
          credentials: 'include',
          body: fd
        });
        const upJson = await upRes.json();
        if (upJson.error) return alert('封面上传失败：' + upJson.error);
        coverUrl = upJson.publicUrl;
      }

      const payload = {
        title,
        content,
        author_email: me.email,
        updated_at: new Date().toISOString(),
        cover_url: coverUrl || undefined,
        id: currentEditId
      };
      const res = await fetch(`${API_BASE}/articles`, {
        method: currentEditId ? 'PATCH' : 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      if (!json.success) return alert('提交失败：' + json.error);

      cancelBtn.click();
      loadArticles(true);
    };

    cancelBtn.onclick = () => {
      document.getElementById('newTitle').value = '';
      document.getElementById('newContent').value = '';
      document.getElementById('coverInput').value = '';
      currentEditId = null;
      cancelBtn.classList.add('hidden');
    };

    window.deleteArticle = async id => {
      if (!confirm('确定删除？')) return;
      const res = await fetch(`${API_BASE}/articles?id=${id}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      const json = await res.json();
      if (!json.success) return alert('删除失败：' + json.error);
      loadArticles(true);
    };

    window.editArticle = row => {
      document.getElementById('newTitle').value = row.title;
      document.getElementById('newContent').value = row.content;
      currentEditId = row.id;
      cancelBtn.classList.remove('hidden');
      window.scrollTo(0,0);
    };

    window.previewArticle = row => {
      document.getElementById('previewTitle').textContent = row.title;
      document.getElementById('previewCover').src = row.cover_url || '';
      document.getElementById('markdownContent').innerHTML = marked.parse(row.content || '');
      document.getElementById('previewModal').classList.remove('hidden');
    };

    window.closePreview = () => document.getElementById('previewModal').classList.add('hidden');

    searchBtn.onclick = () => loadArticles(true, searchInput.value.trim());

    window.addEventListener('scroll', () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 10) {
        loadArticles();
      }
    });

    async function loadArticles(reset = false, keyword = '') {
      if (loading) return;
      loading = true;
      if (reset) {
        articlesTable.innerHTML = '';
        currentPage = 1;
      }
      const url = new URL(`${API_BASE}/articles`);
      url.searchParams.set('page', currentPage);
      url.searchParams.set('limit', limit);
      if (keyword) url.searchParams.set('q', keyword);

      const res = await fetch(url, { credentials: 'include' });
      const { articles, totalPages } = await res.json();

      articles.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="标题">${row.title}</td>
          <td data-label="作者">${row.author_email}</td>
          <td data-label="内容">${row.content?.slice(0,60)}...</td>
          <td data-label="创建时间">${formatBeijingTime(row.created_at)}</td>
          <td data-label="更新时间">${formatBeijingTime(row.updated_at)}</td>
          <td data-label="星期">${getWeekday(row.created_at)}</td>
          <td data-label="封面">${row.cover_url ? `<img src="${row.cover_url}" style="height:40px;">` : ''}</td>
          <td data-label="操作">
            <button class="btn" onclick='previewArticle(${JSON.stringify(row)})'>预览</button>
            <button class="btn" onclick='editArticle(${JSON.stringify(row)})'>编辑</button>
            <button class="btn" onclick='deleteArticle("${row.id}")'>删除</button>
          </td>`;
        articlesTable.appendChild(tr);
      });

      loading = false;
      if (currentPage < totalPages) currentPage++;
    }
  });
</script>
</body>
</html>








